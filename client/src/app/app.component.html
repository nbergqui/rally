<div fxLayout="column" fxLayoutGap="16px" class="container">
  @if (!isLoadingLegs) {
  <h1
    fxLayout="column"
    fxLayout.gt-sm="row"
    fxLayoutGap="8px"
    fxLayoutAlign="start center"
  >
    <span>
      {{ activeLegId }} |
      {{ calculateTimeDifference(legs[activeLegId - 1]).timeDiff }} |
      <span [ngClass]="compareTimeToCheckpoint(legs[activeLegId - 1]).cssClass">
        {{ compareTimeToCheckpoint(legs[activeLegId - 1]).formattedDiff }}
      </span>
    </span>
  </h1>
  <h2>
    Remaining: {{ getRemainingTravelDistance() }}m |
    {{ getRemainingTravelTime() }} | {{ getRemainingPoints() }}p
  </h2>
  <h2>
    Total: {{ getTotalTravelDistance() }}m | {{ getTotalTravelTime() }} |
    {{ getTotalIncludedPoints() }}p
  </h2>
  }

  <h2>Included: {{ sortedIncludedBonuses.length }}</h2>
  @if (isLoadingBonuses) {
  <div>Loading bonuses...</div>
  } @else {
  <mat-accordion multi="true">
    @if (sortedIncludedBonuses.length) { @for (bonus of sortedIncludedBonuses;
    track bonus.BonusCode) {
    <mat-expansion-panel>
      <mat-expansion-panel-header
        [ngClass]="{ 'visited-green': bonus.Visited }"
      >
        <mat-panel-title>
          {{ bonus.BonusCode }} | {{ bonus.BonusName }} | {{ bonus.Points }}p
        </mat-panel-title>
      </mat-expansion-panel-header>
      <div
        fxLayout="column"
        fxLayout.gt-sm="row"
        fxLayoutGap="20px"
        fxFlexWrap="wrap"
      >
        <div fxLayout="row" fxLayout.gt-sm="row" fxFlexWrap="wrap">
          <span class="route-details">
            {{ bonus.Description }}
          </span>
        </div>
        <div
          fxLayout="row"
          fxLayout.gt-sm="row"
          fxLayoutGap="20px"
          fxFlexWrap="wrap"
          class="margin-top-20"
        >
          <a
            mat-flat-button
            fxFlex="1 1 50%"
            [href]="getGoogleMapsUrl(bonus)"
            target="_blank"
            rel="noopener noreferrer"
            >Maps</a
          >
          <a
            mat-flat-button
            fxFlex="1 1 50%"
            [href]="getWazeUrl(bonus)"
            target="_blank"
            rel="noopener noreferrer"
            >Waze</a
          >
          <mat-slide-toggle
            fxFlex
            [(ngModel)]="bonus.Visited"
            (ngModelChange)="updateBonusVisited(bonus, $event)"
            >Visited</mat-slide-toggle
          >
        </div>
        <div
          fxLayout="row"
          fxLayout.gt-sm="row"
          fxLayoutGap="20px"
          fxFlexWrap="wrap"
          class="margin-top-20"
        >
          @if (getRouteForBonus(bonus)) {
          <span class="route-details">
            ETA:
            {{
              calculateEta(
                calculateTimeDifference(legs[activeLegId - 1]).referenceTime,
                getRouteForBonus(bonus).runningTravelTimeMinutes
              )
            }}
            <br />
            From previous:
            {{ formatTime(getRouteForBonus(bonus).travelTimeMinutes) }},
            {{ getRouteForBonus(bonus).distanceMiles }}m
            <br />
            Running total:
            {{ formatTime(getRouteForBonus(bonus).runningTravelTimeMinutes) }}
            (incl. layovers),
            {{ getRouteForBonus(bonus).runningDistanceMiles }}m
          </span>
          }
        </div>
        <div
          fxLayout="row"
          fxLayout.gt-sm="row"
          fxLayoutGap="20px"
          fxFlexWrap="wrap"
          class="margin-top-20"
        >
          <mat-form-field appearance="outline" fxFlex="1 1 25%">
            <mat-label>Layover</mat-label>
            <input
              matInput
              type="number"
              min="0"
              [(ngModel)]="bonus.LayoverMinutes"
              (ngModelChange)="updateBonusLayover(bonus, $event)"
            />
          </mat-form-field>
          <button
            mat-icon-button
            fxFlex="1 1 25%"
            [disabled]="isUpButtonDisabled(bonus)"
            (click)="moveBonusUp(bonus)"
          >
            <mat-icon>arrow_upward</mat-icon>
          </button>
          <button
            mat-icon-button
            fxFlex="1 1 25%"
            [disabled]="isDownButtonDisabled(bonus)"
            (click)="moveBonusDown(bonus)"
          >
            <mat-icon>arrow_downward</mat-icon>
          </button>
          <mat-slide-toggle
            fxFlex="1 1 25%"
            [(ngModel)]="bonus.Include"
            (ngModelChange)="updateBonusInclude(bonus, $event)"
            >Include</mat-slide-toggle
          >
        </div>
      </div>
    </mat-expansion-panel>
    } } @else {
    <p>No included bonuses available.</p>
    }
  </mat-accordion>
  }

  <h2>Available: {{ sortedNotIncludedBonuses.length }}</h2>
  @if (isLoadingBonuses) {
  <div>Loading bonuses...</div>
  } @else {
  <mat-accordion>
    @if (sortedNotIncludedBonuses.length) { @for (bonus of
    sortedNotIncludedBonuses; track bonus.BonusCode) {
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>
          {{ bonus.BonusCode }} | {{ bonus.BonusName }} | {{ bonus.Points }}p
        </mat-panel-title>
      </mat-expansion-panel-header>
      <div
        fxLayout="row"
        fxLayout.gt-sm="row"
        fxLayoutGap="20px"
        fxFlexWrap="wrap"
      >
        <a
          mat-flat-button
          fxFlex="1 1 50%"
          [href]="getGoogleMapsUrl(bonus)"
          target="_blank"
          rel="noopener noreferrer"
          >Maps</a
        >
        <a
          mat-flat-button
          fxFlex="1 1 50%"
          [href]="getWazeUrl(bonus)"
          target="_blank"
          rel="noopener noreferrer"
          >Waze</a
        >
        <mat-slide-toggle
          fxFlex
          [(ngModel)]="bonus.Include"
          (ngModelChange)="updateBonusInclude(bonus, $event)"
          >Include</mat-slide-toggle
        >
      </div>
    </mat-expansion-panel>
    } } @else {
    <p>No not included bonuses available.</p>
    }
  </mat-accordion>
  }

  <h2>Settings</h2>
  <div fxLayout="column" fxLayoutGap="8px">Active Leg</div>
  @if (!isLoadingLegs) {
  <mat-radio-group
    [(ngModel)]="activeLegId"
    fxLayout="row wrap"
    fxLayoutGap="8px"
  >
    @for (leg of legs; track leg.Leg) {
    <mat-radio-button [value]="leg.Leg" (change)="updateActiveLegId(leg.Leg)"
      >Leg {{ leg.Leg }}</mat-radio-button
    >
    }
  </mat-radio-group>
  }
</div>
